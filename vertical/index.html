<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>EPUB実践入門 - 第x章 縦書きレイアウト</title>
<link rel="stylesheet" href="style/vertical.css" />
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
<meta name="viewport" content="height=device-height, initial-scale=1.0, shrink-to-fit=no">
</head>
<body class="chapter" role="doc-chapter">

<header class="bridgehead">
<h1 class="fulltitle runninghead-left">
<span class="title">EPUB実践入門</span>
</h1>
</header>

<main class="hanmen">
<div class="page">

<div role="img" class="image image-page chapter-titlepage" aria-labelledby="chapterx-title">
<p class="image-img-wrap"><img alt="" src="image/chapter-titlepage_96dpi.jpg" srcset="image/chapter-titlepage.jpg 3.125x" class="image-img chapter-titlepage-img" role="presentation" /></p>
<div class="page-content">
<h1 id="chapterx-title" class="ch1 chapter-title runninghead-right">
<span class="title"><span class="label">第<span class="ordinal">X</span>章</span></span> <strong>縦書きレイアウト</strong></h1>
</div>
</div>

<nav class="nav-toc" id="nav-toc">
<h2><a href="#nav-toc">目次</a></h2>
<ol>
<li><a href="#chapterx-1"><span class="ch2-label">X.1</span> <strong>EPUBとCSSレイアウト</strong></a></li>
<li><a href="#chapterx-2"><span class="ch2-label">X.2</span> <strong>縦書きレイアウトの基礎</strong></a></li>
<li><a href="#chapterx-3"><span class="ch2-label">X.3</span> <strong>段落のデザイン</strong></a></li>
<li><a href="#chapterx-4"><span class="ch2-label">X.4</span> <strong>箇条書きのデザイン</strong></a></li>
<li><a href="#chapterx-5"><span class="ch2-label">X.5</span> <strong>表のデザイン</strong></a></li>
<li><a href="#chapterx-6"><span class="ch2-label">X.6</span> <strong>画像のデザイン</strong></a></li>
</ol>
</nav>


<section class="subchapter" id="chapterx-1">
<h2 class="ch2"><span class="ch2-label">X.1</span> <strong>EPUBとCSSレイアウト</strong></h2>

<section class="warning" role="doc-notice">
<p><strong class="warning-title">注意<span class="joint">：</span></strong>この章は<em class="emphasis">まるっと</em>書きかけです。もとい、この文書はCSSレイアウトの確認のために書かれたものです。そのため内容は、不正確なことがあること、EPUBの読書システムでの実機確認はしっかりとは行っていないことに注意してください。</p>
</section>

<section>
<h3 class="ch3">EPUBのレイアウト</h3>
<p>EPUB 3.0では<a href="http://www.idpf.org/epub/301/spec/epub-contentdocs-20140626.html">EPUB Content Documents</a>に規定されているとおり、基本的にはCSSを使ってレイアウトを行います。本章ではCSSによる縦組みレイアウト手法を考えてみます。</p>
<p>ただしEPUB 3.0では、読書システムでのサポートの統一性の観点から、W3Cの最新の仕様をそのまま使えることにはなっていません。また、読書システムで利用したいプロパティを完全にサポートしているとも限りません。そのため、本章で解説したレイアウト手法をEPUB内で利用する場合にはそのことに注意してください。</p>
<p>この章に書くことではないですが、EPUBの制作関連の情報として、日本電子書籍出版社協会の<a href="http://ebpaj.jp/counsel/guide">電書協 EPUB 3 制作ガイド</a>や<a href="http://kadokawa-epub.bookwalker.co.jp/">KADOKAWA-EPUB 制作仕様</a>、<a href="http://vivliostyle.com/ja/samples/">VivliostyleのEPUBサンプル</a>、<a href="http://www.antenna.co.jp/epub/epub-info.html">アンテナハウスのEPUB関連情報</a>、EPUBに関するブログを書かれている<a href="http://densyodamasii.com/">電書魂</a>などが参考になるでしょう。</p>
</section>
<section>
<h3 class="ch3">CSSによる縦書きレイアウト</h3>
<p>ブラウザにおける縦組みのレイアウトの考え方については、W3C技術ノートの「<a href="https://www.w3.org/TR/jlreq/">Requirements for Japanese Text Layout</a>」（日本語訳：<a href="https://www.w3.org/TR/jlreq/ja/">日本語組版処理の要件</a>）がまず参考になります。</p>
<p>また、CSSの仕様書以外では、<a href="http://tategaki.github.io/">縦書きWeb普及委員会のWebサイト</a>にある「技術解説」やビヨンド・パースペクティブ・ソリューションズの<a href="http://csslab.bpsinc.jp/">CSS研究部のサイト</a>、あとはMozilla Developer Networkの<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Reference">CSSリファレンス</a>（<a href="https://developer.mozilla.org/ja/docs/Web/CSS/Reference">日本語訳のページ</a>）が日本語解説として参考になるでしょう。</p>
</section>
</section>

<section class="subchapter" id="chapterx-2">
<h2 class="ch2"><span class="ch2-label">X.2</span> <strong>縦書きレイアウトの基礎</strong></h2>
<p>CSSによる縦組みは、<a href="http://dev.w3.org/csswg/css-writing-modes-3/">CSS Writing Modes Level 3</a>が基礎になります。</p>
<p>要素内の文字列を縦書きにするためには、writing-modeプロパティを次のように使います。ただし、IEではGrouping contentとなる要素に指定する必要があるようです（以降、EPUBのレンダリングエンジンとして使われていないIEやEdgeについては触れません）。</p>
<pre><code class="prettyprint">-ms-writing-mode: tb-rl; /* for IE. */
-webkit-writing-mode: vertical-rl; /* for safari. */
writing-mode: vertical-rl;</code></pre>
<p>これで半角英数字以外のおおよその文字が正立します。正確には<a href="http://unicode.org/reports/tr50/">Unicode<span class="sideways">®</span> Technical Report #50</a>（UTR50）によって<a href="http://www.unicode.org/Public/vertical/revision-15/VerticalOrientation-15.html">規定されています</a>。ただし現在は、この仕様通りに正立しないことがあり得ることに注意してください。</p>
<p>writing-modeの話に戻ります。この指定をbody要素に指定してもFirefox 44.0では上手くブラウザを操作できなくなります。Safariでも現状高さを指定しておく必要があります。そのため、描画領域を縦書き化するためのCSSは次のようになります。</p>
<pre><code class="prettyprint">html {
  height: 100%; /* for firefox, safari. */
}
body {
  -webkit-writing-mode: vertical-rl; /* for safari. */
  writing-mode: vertical-rl;
  width: -moz-calc(100vw); /* for firefox. */
  height: 100%; /* for firefox, safari. */
}</code></pre>
<p>さらに、Mobile Safari対策のために次のmeta要素を入れるようにしてください（EPUBのHTMLでは不要です）。しかし現状Mobile Safariでは描画時に、縦組みの始まりである右端側にスクロール位置が置かれません。</p>
<pre><code class="prettyprint"><span class="keyword">&lt;meta</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="string">"viewport"</span><span class="pln"> </span><span class="atn">content</span><span class="pun">=</span><span class="string">"height=device-height, initial-scale=1.0, shrink-to-fit=no"</span><span class="keyword">&gt;</span></code></pre>
<p>また、寝ている状態（初期値：mixed）になっている半角文字を正立させたい場合には、text-orientationプロパティにuprightを指定します。逆に日本語等を寝せたい場合にはsidewaysを指定します。</p>
<!--<pre><code class="prettyprint">text-orientation: upright;</code></pre>-->
<p>一部の文字だけ縦中横にしたい場合、基本的にはtext-combine-uprightプロパティにallを指定します。ですが、各ブラウザへの実装が目下進められている段階であり、現時点で使用するためにはその指定が煩雑です。</p>
</section>

<section class="subchapter" id="chapterx-3">
<h2 class="ch2"><span class="ch2-label">X.3</span> <strong>段落のデザイン</strong></h2>
<p>段落本文をデザインするに当たって現状重要になる仕様は、<a href="https://drafts.csswg.org/css-fonts/">CSS Fonts Module Level 3</a>と<a href="https://drafts.csswg.org/css-text-3/">CSS Text Module Level 3</a>、<a href="https://drafts.csswg.org/css-text-decor-3/">CSS Text Decoration Module Level 3</a>です。また、段落のより複雑なレイアウトを制御するために、<a href="https://drafts.csswg.org/css-inline/">CSS Inline Layout Module Level 3</a>、<a href="https://drafts.csswg.org/css-line-grid/">CSS Line Grid Module Level 1</a>などがあります。</p>

<section>
<h3 class="ch3">フォントの指定</h3>
<p>ブラウザ上で縦書きを使う場合、WindowsとMac OSの両方にある書体である游明朝、または游ゴシックを指定しておくのが簡単には按配が良くお勧めです。なお、読書システムでは標準の日本語フォントが搭載されていることも多いので、後述のMonospace以外はEPUBで書体を指定しないほうが無難です。</p>
<p>ただし、Firefoxでは縦書きで游書体を指定した際は、日本語と半角の英数字でベースラインのずれが気になるかと思います。そのため英字の書体も合わせて指定してみても良いかもしれません。</p>
<p>ということで、このページでは、次のように指定しています。</p>
<pre><code class="prettyprint">@font-face {
  font-family: 'Yu Mincho Custom';
  src: local('Yu Mincho'), local('YuMincho');
}
@font-face {
  font-family: 'Yu Mincho Custom';
  src: local('Times New Roman');
  unicode-range: U+0-2FF;
}
@font-face {
  font-family: 'Yu Gothic Custom';
  src: local('Yu Gothic'), local('YuGothic');
}
@font-face {
  font-family: 'Yu Gothic Custom';
  src: local('Trebuchet MS');
  unicode-range: U+0-2FF;
}
p {
  font-family: 'Yu Mincho Custom', serif;
}
h1, h2, h3, h4, h5, h6, li, dt, dd, figcaption {
  font-family: 'Yu Gothic Custom', sans-serif;
}</code></pre>
<p>なお、OpenTypeフォント自体が持っている情報をCSSで有効化するためには、font-variantプロパティやfont-feature-settingsプロパティなどを使います。仕様書以外に、<a href="http://help.typekit.com/customer/ja/portal/articles/1789708">Adobe Typekitのヘルプセンター</a>に日本語で説明があり、参考になるでしょう。</p>
<p>また、コードのフォントはデフォルトではSafariできれいに表示されません。よって、Safari用に具体的に指定する必要があります。</p>
<pre><code class="prettyprint">@font-face {
  font-family: 'Vertical Mono';
  src: local('Consolas'), local('Menlo'); /* for safari, and adjust windows. */
}
code, samp, var {
  font-family: 'Vertical Mono', monospace; /* for sfarii, and adjust windows. */
}</code></pre>
<p>また、iPhone（iOS 9）のMobile Safari上では自動的にフォントサイズに修正が入るため、これを打ち消す必要があります。それらの対応としてこのページでは、次のように指定しています。</p>
<pre><code class="prettyprint">body {
  -webkit-text-size-adjust: 100%; /* for font size in ios safari. */
}</code></pre>
<p>読書システムでは、Monospaceの書体を包含していないことも多いです。そこで、 <a href="https://github.com/adobe-fonts/source-han-code-jp">Source Han Code JP</a>や、日本語のフォント幅に正確性を求めないのであれば<a href="https://github.com/nathco/Office-Code-Pro">Office Code Pro</a>を含めるのが良いでしょう。</p>
</section>

<section>
<h3 class="ch3">段落本文内の英数字</h3>
<p>縦書きを想定したHTMLの本文を書くにあたり、本文内の英数字は半角で書いて構いません。また、記号は基本的に全角で書きます。つまり、横書きと同じです。ただし、作品において英数字の文字列が明らかに短いものしか記載しない場合は、英数字を全角で書いてすべて正立させてしまう方針もあるでしょう。</p>
<p>なお、半角スペースが入らない半角文字の文字列は、ブラウザによっては<code>word-break: all;</code>をかけないと自動的に次行に送られないことに注意してください。通常はそこまで長い文字列は記載されないと考え、例えば次のように設定しておき、都合に合わせてHTML側に&lt;span&gt;タグを入れてもよいでしょう。</p>
<pre><code class="prettyprint">/* .url = URL文字列,
:root:lang(en) = 英語文字列 を想定。 */
code, samp, .url, :root:lang(en) {
  word-break: break-all;
}</code></pre>
<p>なお、このページではfigcaption要素内で絵文字を連打しているために、Firefoxでは次行に送られないので、あわせてこの指定を行っています。</p>
</section>

<section>
<h3 class="ch3">リンクのデザイン</h3>
<p>リンクのデザインは、縦書きの場合、文字列の右側に実線が引かれていることをブラウザに対して<a href="https://drafts.csswg.org/css-text-decor-3/#example-affafc32">勧めています</a>。</p>
<p>なお、Firefox 44ではa要素に対して、text-orientation: sideways;を指定すると実線が引かれなくなってしまいます。</p>
</section>

<section>
<h3 class="ch3">ルビ</h3>
<p>ルビを簡単に確認します。ルビのレイアウトは<a href="https://drafts.csswg.org/css-ruby-1/">CSS Ruby Layout Module Level 1</a>にて規定されています。ルビのレイアウトにそこまで気を使わない場合には、グループルビとインラインルビを把握していれば十分でしょう。</p>
<p>また、Chrome 49ではfont-feature-settingsプロパティを使うこと（値：ruby）でルビ用字形が有効になるようです（Windowsで確認）。ただし、この指定はブラウザのデフォルトCSSで指定することを勧めていて、CSS作成者が指定すべきではないことに注意してください。</p>
<p>例えば、このページでは次のCSS（以降SCSSの場合もある）を適用してきます。</p>
<pre><code class="prettyprint">rt, rtc {
  font-variant-east-asian: ruby;
  -webkit-font-feature-settings: 'ruby';
  font-feature-settings: 'ruby';
}
rtc {
  ruby-position: under;
}
@supports not (display: ruby-text-container) { /* for chrome. */
  rtc {
    &amp;::before {
      display: inline;
      content: '\FF08';
    }
    &amp;::after {
      display: inline;
      content: '\FF09';
    }
  }
}
@mixin inline-ruby {
  display: inline;
  font-size: inherit;
  white-space: inherit;
  text-emphasis: inherit;
  font-variant-east-asian: inherit;
  -webkit-font-feature-settings: inherit;
  font-feature-settings: inherit;
}
.inline-ruby {
  @include inline-ruby;
  rt, rp, rtc {
    @include inline-ruby;
  }
}
</code></pre>
<p>その結果、次のよう描画されます。最後の「札幌（さっぽろ）」と表示されている箇所がインラインルビです。</p>
<figure class="bfl example">
<p>先日、イベントに参加するために<ruby>北海道<rp>（</rp><rt>ほっかいどう</rt><rp>）</rp></ruby>に行ってきました。雪が今年はあまり降っていないということで<ruby>大通<rp>（</rp><rt>おおどおり</rt><rp>）</rp></ruby>などの歩道は地面が<ruby>見<rp>（</rp><rt>み</rt><rp>）</rp></ruby>えていました。食事については<ruby>🍣<rp>（</rp><rt>美味しいお寿司</rt><rp>）</rp></ruby>をたくさん食べてきました。<ruby>鮪<rp>（</rp><rt>まぐろ</rt><rp>）</rp></ruby>やタコ、<ruby>北寄貝<rp>（</rp><rt>ほっきがい</rt><rp>）</rp></ruby>のほか、旬の<ruby>鰤<rp>（</rp><rt>ぶり</rt><rp>）</rp></ruby>や<ruby>真鱈の白子<rp>（</rp><rt>たちぽん</rt><rp>）</rp></ruby>などなど……。その時の<ruby>写真<rp>（</rp><rt>しゃしん</rt><rp>；</rp><rtc>Photo</rtc><rp>）</rp></ruby>をこのページに掲載します。</p>
<p style="text-align: right;">—— <span class="tcy">2</span><span class="tcy">0</span><span class="tcy">1</span><span class="tcy">6</span>年、<ruby class="inline-ruby">札幌<rp>（</rp><rt>さっぽろ</rt><rp>）</rp></ruby>にて</p>
</figure>

<p>なお、EPUB内にrtc要素があると、現在のepubcheck 4.0.1での確認がパスできないことに注意してください。</p>
</section>
</section>

<section class="subchapter" id="chapterx-4">
<h2 class="ch2"><span class="ch2-label">X.4</span> <strong>箇条書きのデザイン</strong></h2>
<p>（後で書くかも。）</p>
</section>

<section class="subchapter" id="chapterx-5">
<h2 class="ch2"><span class="ch2-label">X.5</span> <strong>表のデザイン</strong></h2>
<p>この節では、表のデザインを考えます。</p>
<p>なお、EPUB内で縦組みの複雑なレイアウトを行う場合、<code>display: table;</code>による指定が現状もっとも安全でしょう。</p>
<p>ここで図版はすべてfigure要素を使います。</p>
<figure class="bfl table">
<table>
<thead>
<tr><th>px値</th><th>em値</th></tr>
</thead>
<tbody>
<tr><td>16px</td><td>1em</td></tr>
<tr><td>15px</td><td>0.9375em</td></tr>
<tr><td>14px</td><td>0.875em</td></tr>
<tr><td>13px</td><td>0.8125em</td></tr>
<tr><td>12px</td><td>0.75em</td></tr>
<tr><td>11px</td><td>0.6875em</td></tr>
<tr><td>10px</td><td>0.625em</td></tr>
</tbody>
</table>
</figure>
<p>次に、キャプションがある場合を考えてみます。</p>
<figure class="bfl table table-fc">
<figcaption class="bfl-fc"><span class="bfl-fc-title">表<span class="bfl-fc-ordinal">2</span></span> pxとemの関係</figcaption>
<table>
<thead>
<tr><th>px値</th><th>em値</th></tr>
</thead>
<tbody>
<tr><td>16px</td><td>1em</td></tr>
<tr><td>15px</td><td>0.9375em</td></tr>
<tr><td>14px</td><td>0.875em</td></tr>
<tr><td>13px</td><td>0.8125em</td></tr>
<tr><td>12px</td><td>0.75em</td></tr>
<tr><td>11px</td><td>0.6875em</td></tr>
<tr><td>10px</td><td>0.625em</td></tr>
</tbody>
</table>
</figure>
<p>次に、表を横書きにしてみます。なお、横書きにする場合、描画領域を超えると問題があります。</p>
<figure class="bfl table-horizontal">
<table>
<thead>
<tr><th>px値</th><th>em値</th></tr>
</thead>
<tbody>
<tr><td>16px</td><td>1em</td></tr>
<tr><td>15px</td><td>0.9375em</td></tr>
<tr><td>14px</td><td>0.875em</td></tr>
<tr><td>13px</td><td>0.8125em</td></tr>
<tr><td>12px</td><td>0.75em</td></tr>
<tr><td>11px</td><td>0.6875em</td></tr>
<tr><td>10px</td><td>0.625em</td></tr>
</tbody>
</table>
</figure>
<p>次に、横書きの表にキャプションを加えてみます。</p>
<figure class="bfl table-horizontal">
<figcaption class="bfl-fc"><span class="bfl-fc-title">表<span class="bfl-fc-ordinal">4</span></span> pxとemの関係</figcaption>
<table>
<thead>
<tr><th>px値</th><th>em値</th></tr>
</thead>
<tbody>
<tr><td>16px</td><td>1em</td></tr>
<tr><td>15px</td><td>0.9375em</td></tr>
<tr><td>14px</td><td>0.875em</td></tr>
<tr><td>13px</td><td>0.8125em</td></tr>
<tr><td>12px</td><td>0.75em</td></tr>
<tr><td>11px</td><td>0.6875em</td></tr>
<tr><td>10px</td><td>0.625em</td></tr>
</tbody>
</table>
</figure>

<p>表が横に長く、セルが多い場合には、画面領域から落ちてしまいます。</p>

<figure class="bfl table-horizontal">
<figcaption class="bfl-fc"><span class="bfl-fc-title">表<span class="bfl-fc-ordinal">4</span></span> pxとemの関係</figcaption>
<table>
<thead>
<tr><th>px値</th><th>em値</th><th>em値</th><th>em値</th><th>em値</th></tr>
</thead>
<tbody>
<tr><td>16px</td><td>1em</td><td>1em</td><td>1em</td><td>1em</td></tr>
<tr><td>15px</td><td>0.9375em</td><td>0.9375em</td><td>0.9375em</td><td>0.9375em</td></tr>
<tr><td>14px</td><td>0.875em</td><td>0.875em</td><td>0.875em</td><td>0.875em</td></tr>
<tr><td>13px</td><td>0.8125em</td><td>0.8125em</td><td>0.8125em</td><td>0.8125em</td></tr>
<tr><td>12px</td><td>0.75em</td><td>0.75em</td><td>0.75em</td><td>0.75em</td></tr>
<tr><td>11px</td><td>0.6875em</td><td>0.6875em</td><td>0.6875em</td><td>0.6875em</td></tr>
<tr><td>10px</td><td>0.625em</td><td>0.625em</td><td>0.625em</td><td>0.625em</td></tr>
</tbody>
</table>
</figure>

<p>つまり、本文縦組みのスタイルでは、表内の文字組が縦書きでに行（tr要素）が左方向に並んでいく場合、本文のあるhtmlに表を埋め込むのは良いのですが（セルがたくさんあると下に切れますが）、表内が横書きで行（tr要素）が下方向に並んでいく場合、本文に埋め込むのは（右方向にも、下方向にも）非常に気をつけないといけなくなるのが分かります。そのため、表内が横書きなら別htmlするのを基本としても良いでしょう。</p>
</section>

<section class="subchapter" id="chapterx-6">
<h2 class="ch2"><span class="ch2-label">X.6</span> <strong>画像のレイアウト</strong></h2>
<p>この節では、縦組みレイアウトにおける画像の配置を考えてみます。</p>
<section class="figure-image-for-web">
<h3 class="ch3">ブラウザにおける300dpi相当の画像の配置</h3>
<p>まずは、EPUBを考えずにブラウザでの配置を確認します。</p>
<p>ベースCSSとして、img要素に対して次のスタイルがかかっているとします。</p>
<pre><code class="prettyprint">img {
  max-width: 100vw;
  max-height: 100%;
}</code></pre>
<p>300dpi相当の画像を図版として配置する場合、HTMLは次のようになります。</p>
<pre><code class="prettyprint"><span class="keyword">&lt;figure</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl image"</span><span class="keyword">&gt;</span><span class="pln">
</span><span class="keyword">&lt;p</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"image-img-wrap"</span><span class="keyword">&gt;&lt;img</span><span class="pln"> </span><span class="atn">alt</span><span class="pun">=</span><span class="string">"🍣"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="string">"image/sushi-tuna_96dpi.jpg"</span><span class="pln"> </span><span class="atn">srcset</span><span class="pun">=</span><span class="string">"image/sushi-tuna.jpg 3.125x"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"image-img"</span><span class="pln"> </span><span class="keyword">/&gt;&lt;/p&gt;</span><span class="pln">
</span><span class="keyword">&lt;/figure&gt;</span></code></pre>
<p>class属性について触れておきます。.bflは、画像に限らずfigure要素が使われる図版を設定するためのモジュールを指定します。.imageはfigure要素内に配置されるのが画像の図版であること示すモジュールです。.image-img-warpは画像図版であるimg要素を包含していることを示します。.image-imgは画像図版のimg要素そのものを指します。</p>
<p>CSSは次のように指定します。</p>
<pre><code class="prettyprint">.bfl {
  margin: 0 1.5em 0 0;
  max-height: 100%;
  + * {
    margin-right: 1.5em;
  }
}
.image-img {
  display: block;
}</code>
</pre>
<p>ここで重要なのは、max-height: 100%;の指定です。これにより、後述のキャプションを画像の下部に配置する場合において、img要素が描画領域の高さを判断できるようになります。img要素をblock化してるのは，余計な余白を描画しないように念のため設定しています<span class="noteref-wrap"><span class="joint">（</span><a id="img-block-noteref" class="noteref" href="#img-block">※<span class="tcy">1</span></a><span class="joint">）</span></span>。</p>
<aside class="footnote" id="img-block" role="doc-footnote">
<p><a href="#img-block-noteref" class="referer">※<span class="tcy">1</span></a> 以前block化しないと，謎の余白が生成されていたことがありました。現在は必要ないかもしれません。その代わりに、標準のp要素のスタイルに注意しないといけませんが。</p>
</aside>
<p>すると、次のように配置されます。</p>
<figure class="bfl image">
<p class="image-img-wrap"><img alt="🍣" src="image/sushi-tuna_96dpi.jpg" srcset="image/sushi-tuna.jpg 3.125x" class="image-img" /></p>
</figure>
<!--
<figure class="bfl image">
<p class="image-img-wrap"><img alt="🍣" src="image/sushi-tuna_96dpi.jpg" srcset="image/sushi-tuna.jpg 864w, image/sushi-tuna_96dpi.jpg 276w" sizes="276px" /></p>
</figure>
-->
<p>これに、キャプションのある場合を考えてみます。HTMLは次のようになります。キャプションを持つことを示すために、figure要素のclass属性にbfl-wfcを加えています。</p>
<pre><code class="prettyprint"><span class="keyword">&lt;figure</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl bfl-wfc image"</span><span class="keyword">&gt;</span><span class="pln">
</span><span class="keyword">&lt;p</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"image-img-wrap"</span><span class="keyword">&gt;&lt;img</span><span class="pln"> </span><span class="atn">alt</span><span class="pun">=</span><span class="string">"図2"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="string">"image/sushi-tuna_96dpi.jpg"</span><span class="pln"> </span><span class="atn">srcset</span><span class="pun">=</span><span class="string">"image/sushi-tuna.jpg 3.125x"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"image-img"</span><span class="pln"> </span><span class="keyword">/&gt;&lt;/p&gt;</span><span class="pln">
</span><span class="keyword">&lt;figcaption</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl-fc"</span><span class="keyword">&gt;&lt;span</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl-fc-title"</span><span class="keyword">&gt;</span><span class="pln">図</span><span class="keyword">&lt;span</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl-fc-ordinal"</span><span class="keyword">&gt;</span><span class="pln">2</span><span class="keyword">&lt;/span&gt;&lt;/span&gt;</span><span class="pln"> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</span><span class="keyword">&lt;/figcaption&gt;</span><span class="pln">
</span><span class="keyword">&lt;/figure&gt;</span></code></pre>
<p>figcaption要素を持つ場合、img要素のalt属性は<a href="https://www.w3.org/TR/html5/embedded-content-0.html#images-that-include-text">図番号のみを入れる形</a>で構いません。</p>
<p>CSSは今回、次のように記述しました。</p>
<pre><code class="prettyprint">.bfl-wfc .image-img {
  max-width: 75vw;
}
.bfl-fc {
  display: block;
  font-size: 0.8em;
  margin-right: 0.5em;
  line-height: 1.5;
  text-align: justify;
}
.bfl-fc-title {
  font-weight: bold;
  margin-bottom: 0.25em;
}
.bfl-fc-ordinal {
  @include text-combine-upright-all;
}</code></pre>
<p>ここで重要になるのは、描画領域における画像とキャプションの割合です。画像が大きい場合には、描画領域の横幅<span class="tcy">75</span>％を上限とし、残りの<span class="tcy">25</span>％分の横幅分を最低でもキャプションに割り当てるようにしました（以降、キャプションが表示される場合の割合はキャプションが画像下にあっても同じ）。そのため今回の設計では、キャプションが<span class="tcy">25</span>％以上の横幅を持つと、描画領域からキャプションが落ちることに注意してください。</p>
<figure class="bfl bfl-wfc image">
<p class="image-img-wrap"><img alt="図2" src="image/sushi-tuna_96dpi.jpg" srcset="image/sushi-tuna.jpg 3.125x" class="image-img" /></p>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">2</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<p>ちなみに図番号が<span class="tcy">2</span>桁の場合のには次のように表示されます。</p>
<figure class="bfl image">
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">21</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<p>次に、キャプションを画像の下に配置してみます。HTMLは、先のHTMLに対して、figure要素のclass属性にbfl-wfc-wsdを加えます。その際、CSSを上書きする必要性から、bfl-wfcの後にbfl-wfc-wsdを記述してください。</p>
<pre><code class="prettyprint"><span class="keyword">&lt;figure</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl bfl-wfc bfl-wfc-wsd image"</span><span class="keyword">&gt;</span><span class="pln">
</span><span class="keyword">&lt;p</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"image-img-wrap"</span><span class="keyword">&gt;&lt;img</span><span class="pln"> </span><span class="atn">alt</span><span class="pun">=</span><span class="string">"図3"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="string">"image/sushi-tuna_96dpi.jpg"</span><span class="pln"> </span><span class="atn">srcset</span><span class="pun">=</span><span class="string">"image/sushi-tuna.jpg 3.125x"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"image-img"</span><span class="pln"> </span><span class="keyword">/&gt;&lt;/p&gt;</span><span class="pln">
</span><span class="keyword">&lt;figcaption</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl-fc"</span><span class="keyword">&gt;&lt;span</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl-fc-title"</span><span class="keyword">&gt;</span><span class="pln">図</span><span class="keyword">&lt;span</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl-fc-ordinal"</span><span class="keyword">&gt;</span><span class="pln">3</span><span class="keyword">&lt;/span&gt;&lt;/span&gt;</span><span class="pln"> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</span><span class="keyword">&lt;/figcaption&gt;</span><span class="pln">
</span><span class="keyword">&lt;/figure&gt;</span></code></pre>
<p>そして、CSSは次のように記述します。</p>
<pre><code class="prettyprint">@media screen and (min-height: $page-height) {
  .bfl-wfc-wsd {
    -webkit-writing-mode: horizontal-tb; /* for safari. */
    writing-mode: horizontal-tb;
    display: table;
    border-collapse: collapse;
    .image-img-wrap {
      display: table-cell;
      height: intrinsic;
      height: fit-content;
      min-width: -moz-calc(16em * 0.8);
    }
    .image-img {
      max-width: 100vw;
      max-height: 75%;
      max-height: -moz-calc(75vh - 6em - 1em);
      margin: 0 auto; /* in case width of caption is longer than image. */
    }
    .bfl-fc {
      display: table-caption;
      caption-side: bottom;
      min-width: 16em;
      margin: 0.35em 0 0;
    }
    .bfl-fc-title {
      margin: 0 0.25em 0 0;
    }
  }
}
</code></pre>
<p>基本的には、CSSで表組しているだけです。画像の高さに対する最大値は、前述していたように、.bflに指定した<code>height-max: 100%</code>の指定を明示することで、有効値を計算してくれます。</p>
<p>なお、Firefoxでは縦書きの中で横書きにした場合、その要素は縦書きの親要素の高さを<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1255304">取得できません</a>。ここでは、描画領域の高さをもとに画面領域にはみ出さないように調整しています。また、Firefoxで、かつ画面のピクセル密度が<span class="tcy">1</span>よりも大きい場合に、.image-img-wrap要素の領域が画像の領域まで<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1251327">収縮できません</a>。そのため、現状その分画像の周りに余白ができてしまいます。</p>
<figure class="bfl bfl-wfc bfl-wfc-wsd image">
<p class="image-img-wrap"><img alt="図3" src="image/sushi-tuna_96dpi.jpg" srcset="image/sushi-tuna.jpg 3.125x" class="image-img" /></p>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">3</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<!--
<figure class="bfl bfl-wfc bfl-wfc-wsd image">
<p class="image-img-wrap"><img alt="🍣" src="image/sushi-tuna_96dpi.jpg" srcset="image/sushi-tuna.jpg 864w, image/sushi-tuna_96dpi.jpg 276w" sizes="276px class="image-img" /></p>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">3</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
-->
<p>ここで、縦に画像が長い場合も確認してきましょう。</p>
<p>キャプションがない場合は次のとおりです。</p>
<figure class="bfl image">
<p class="image-img-wrap"><img alt="街路" src="image/snow-street-day_96dpi.jpg" srcset="image/snow-street-day.jpg 3.125x" class="image-img" /></p>
</figure>
<p>キャプションがある場合は次のとおりです。</p>
<figure class="bfl bfl-wfc bfl-wfc-wsd image" id="no-setting-height-in-firefox">
<p class="image-img-wrap"><img alt="図5" src="image/snow-street-day_96dpi.jpg" srcset="image/snow-street-day.jpg 3.125x" class="image-img" /></p>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">5</span></span> ⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄</figcaption>
</figure>
<p>次に、ページメディアにおいて、ページ内に<span class="tcy">1</span>つの図版だけ表示したい画像も考えておきます。例えば、キャプションも画像に含まれている場合です。その場合は、figure要素のclass属性にimage-pageを加えておくことにします。</p>
<figure class="bfl image image-page">
<p class="image-img-wrap"><img  alt="出発待ちの電車" src="image/train_96dpi.jpg" srcset="image/train.jpg 3.125x" title="🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃" class="image-img" /></p>
</figure>
<p>次に、図版に<span class="tcy">2</span>つの画像が縦に並ぶ場合を考えてみます。</p>
<p>HTMLは、それぞれの画像を、これまでのfigure.image要素のclass属性につけていたclass属性をimage-tandemのみに変えて部品として用意します。そして、それらをdiv.images要素で包含します。さらに、figure.bfl.tandem要素で包含します。</p>
<p>CSSの解説はfigure.image要素で記述した時の応用です。</p>
<p>その結果、次のように表示できます。</p>
<figure class="bfl tandem image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図7a-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図7a-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
</figure>
<!--
<p>縦に短い場合も確認しておきます。</p>
<figure class="bfl tandem image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図7b-①" src="image/216x162.jpg" srcset="image/432x324.jpg 3.125x" title="🍚1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="iamge-img-wrap"><img alt="図7b-②" src="image/216x162-2.jpg" srcset="image/432x324-2.jpg 3.125x" title="🍚2" class="image-img" /></p>
</figure>
</div>
</figure>
-->
<p>縦に長い場合も確認しておきます。画像周りの値を変更したのみです。</p>
<figure class="bfl tandem image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図7c-①" src="image/snow-street-day_96dpi.jpg" srcset="image/snow-street-day.jpg 3.125x" title="⛄1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図7c-②" src="image/snow-street-night_96dpi.jpg" srcset="image/snow-street-night.jpg 3.125x" title="⛄2" class="image-img" /></p>
</figure>
</div>
</figure>
<p>これに対して、キャプションがある場合は次のようになります。先のfigure.image要素の場合と同じようにfigcaption要素を加えているので、figure.tandem要素のclass属性にtandem-fcを加えてキャプションがあることをfigure要素側で把握させています。</p>
<figure class="bfl tandem tandem-wfc image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図8-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図8-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">8</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<p>さらに、キャプションを画像の下に持った例です。</p>
<figure class="bfl tandem tandem-wfc tandem-wfc-wsd image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図9a-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図9a-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">9a</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<p>縦に長い場合も確認しておきます。</p>
<figure class="bfl tandem tandem-wfc tandem-wfc-wsd image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図9b-①" src="image/snow-street-day_96dpi.jpg" srcset="image/snow-street-day.jpg 3.125x" title="⛄1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図9b-②" src="image/snow-street-night_96dpi.jpg" srcset="image/snow-street-night.jpg 3.125x" title="⛄2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">9b</span></span> ⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄</figcaption>
</figure>
<p>次に、横に並ぶ場合を考えてみます。横に並ぶ場合は、左から右に並ぶ場合と、その逆が考えられます。まずは、左から右で考えてみましょう。</p>
<p>なお、figure要素のclass属性につけていたimage（tandem）をsidebysideに変えています。</p>
<figure class="bfl sidebyside image">
<div class="sidebyside-wrap">
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図10-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図10-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
</figure>
<p>これに対して、キャプションがある場合は次のとおりです。</p>
<p>キャプションがあることをfigure要素が知らないと横幅が画面領域を超えてしまうため、figure要素のclass属性に sidebyside-fcを加えています。</p>
<figure class="bfl sidebyside sidebyside-wfc image">
<div class="sidebyside-wrap">
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図11-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図11-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">11</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<p>キャプションが下に配置する場合には、次のとおりです。</p>
<p>先と同じく、キャプションがあることをfigure要素が知らないと横幅が画面領域を超えてしまうため、figure要素のclass属性に sidebyside-with-fcを加えています。</p>
<figure class="bfl sidebyside sidebyside-wfc sidebyside-wfc-wsd image">
<div class="sidebyside-wrap">
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図12-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図12-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">12</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<p>次に、横並びで、右から左に並ぶ図版を考えてみます。</p>
<p>figure要素のclass属性につけていたfiugre.sidebyside要素のclass属性にsidebyside-rtlを足します。</p>
<p>なお、directionプロパティを使うと手軽に左右反転できるのですが、EPUBではdirectionプロパティを使えません。</p>
<figure class="bfl sidebyside-rtl">
<div class="sidebyside-rtl-wrap">
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図13-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図13-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
</figure>

<p>これに対して、キャプションがある場合は次のとおりです。</p>
<p>figure.sidebyside.sidebyside-fc要素のclass属性にsidebyside-rtlを加えています。</p>
<figure class="bfl sidebyside-rtl sidebysside-rtl-wfc">
<div class="sidebyside-rtl-wrap">
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図14-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図14-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">14</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<p>キャプションが下に配置する場合には、次のとおりです。</p>
<p>先と同じように、figure.sidebyside.sidebyside-fc.sidebyside-sdl要素のclass属性にsidebyside-rtlを加えています。</p>
<figure class="bfl sidebyside-rtl sidebyside-rtl-wfc sidebyside-rtl-wsd image">
<div class="sidebyside-rtl-wrap">
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図15-①" src="image/sushi-shellfish_96dpi.jpg" srcset="image/sushi-shellfish.jpg 3.125x" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図15-②" src="image/sushi-milt_96dpi.jpg" srcset="image/sushi-milt.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">15</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
</section>
<section>
<h3 class="ch3">EPUBに対応させることを検討する</h3>
<p>ここまでの画像配置の手法は、ブラウザでの配置方法です。しかし、EPUBではこのままは上手くいきません。EPUB 3.0ではHTML5の勧告を元にしていますので、現在srcset属性を使うとValidatorが通らないためです。ただし、EPUB 3.1では使えるようになることが<a href="https://github.com/IDPF/epub-revision/issues/429">予定されています</a>。</p>
<p>そこでこの項では、srcset属性を使わずにHTMLとCSSで図版を配置することを、検討してみます（EPUB対応の結論は次項のSVGラッピングを参照してください）。</p>
<ul>
<li>height属性を指定する：しかし横幅が小さいデバイスで見た時に矩形比が保てません。</li>
<li>image-resolutionプロパティを使う：詳しく見ていませんが、このプロパティを使うことで対応できるようになると思われます。しかし実装されていません。</li>
<li>zoomプロパティ使う：セレクタでのzoomプロパティの使用は非標準です。特にFirefoxでは利用できません。</li>
<li>transformプロパティを使う：親ボックスが縮小されず、余白が出てしまいます。</li>
</ul>
<p>各手法において補足があるとおり、完全な解決策はないのですが、height属性を使うことになるでしょう（特に後述の軽さを求めることも考慮しなければなりませんので）。</p>

<p>srcset属性の以外にも問題があります。</p>
<p>まず、読書システムとしてよく利用されるReadiumやiBooksでは、縦書きの中で横書きを指定していたfigure[class$=sdl]要素において、画像のmax-heightの％指定が有効にならないというバグがあります。これにより、画像が大きいと描画領域から落ちてしまいます。そこで、!importantをつけて強制的にその指定を有効化させる必要があります。</p>
<p>また、Kindleでは現在max-heightなどの最大値／最小値の指定がサポートされていません。そのため、Kindle用のメディアクエリーである@amzn-kf8を使って、これらの処理を迂回させる必要があります。<p>
<p>さらに、前項で解説してきたCSSレイアウトで実装すると、（たぶん）最大値関係のvwの計算と画像の自動縮小処理で、現状のiBooks 4.7（on iOS 9 / iPad Air 1）で図版が数枚あると動作がかなり重くなってしまいます（iPhoneの場合はどうやら処理がある程度パスされること、Kindleではそもそも最大値の計算が効かないので、iPadのみで重くなります。現時点でAndroidのタブレットでは確認していません）。</p>
<p>……ということで、前項の図版のCSSレイアウトは基本的に「とりあえずできた」レベルであって、そのままEPUBに持ち込むことはできない話だったのが分かります。</p>
</section>
<div class="figure-image-for-epub">
<p>そこで、描画処理を軽くるするに、図版の画像の大きさを指定しまうことを検討してみます。これによりsrcset属性を使わなくても、画像の大きさがピクセル密度が異なっても同じように表示できるようになるという、もう一つの問題の解決策にもなるからです。しかし、画像の縦と横の長さを両方とも指定するのはあまりお勧めできません。なぜなら読書システムの描画領域の大きさがばらばらだからです。その際、画像の長辺が描画領域よりも画像が大きいと矩形比が保てなくなります。よって、全体が縦書きであれば縦方向を固定するheight属性を、横書きであればwidth属性を指定して、別方向（進行方向）の長さは描画領域の長さに応じて自動的に調整をかけられるようにするのが無難な対応になると考えています。</p>
<p>また、単位vw, vhについては「計算処理のコストが高いと考えられること」「スクロール型の読書システムの場合には画面幅に図版が入りきらなくても大きくは問題にならないこと」を踏まえて<span class="tcy">%</span>に指定し直します。ただしこの場合、キャプションのみが次ページに表示される問題が発生しえます。これはvwを使って画像自体の最大値を指定してもheight属性のほうが優先されるためです。この問題にはここでは目をつぶります。</p>
<p>この対応策を用いることで、EPUBでの縦書きレイアウトにおける図版画像の配置のHTMLを、以下のように書き直します。CSSは現時点においてはこのページでは先のものと同じスタイルを適用させています。なお、gokko-soup.jpgは300dpiの画像です。</p>

<pre><code class="prettyprint"><span class="keyword">&lt;figure</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"bfl image"</span><span class="keyword">&gt;</span><span class="pln">
</span><span class="keyword">&lt;p</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"image-img-wrap"</span><span class="keyword">&gt;&lt;img</span><span class="pln"> </span><span class="atn">alt</span><span class="pun">=</span><span class="string">"ごっこ汁"</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="string">"image/gokko-soup.jpg"</span><span class="pln"> </span><span class="atn">height</span><span class="pun">=</span><span class="string">"230"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="string">"image-img"</span><span class="pln"> </span><span class="keyword">/&gt;&lt;/p&gt;</span><span class="pln">
</span><span class="keyword">&lt;/figure&gt;</span></code></pre>

<figure class="bfl image">
<p class="image-img-wrap"><img alt="ごっこ汁" src="image/gokko-soup.jpg" height="230" class="image-img" /></p>
</figure>

<p>キャプションがある場合は次のとおりです（以降、絵文字は適宜JIS2004の範囲内にある文字に置き換えて見てください）。ただし、先述したように、図版画像が描画領域よりも大きい場合、キャプションが別ページに表示されてしまいます。</p>

<figure class="bfl bfl-wfc image">
<p class="image-img-wrap"><img alt="図2" src="image/gokko-soup.jpg" height="230" class="image-img" /></p>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">2</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>

<p>キャプションが下に配置する場合は次のとおりです。ただしiphoneのibooksでは、図版画像の上下に余白ができてしまったり、図版画像の大きさの割合がやや小さくなったりと問題が多少あります。しかしながら、クリティカルな問題ではないため、現状この形式を使うのが良いでしょう。</p>

<figure class="bfl bfl-wfc bfl-wfc-wsd image">
<p class="image-img-wrap"><img alt="図2" src="image/gokko-soup.jpg" height="230" class="image-img" /></p>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">2</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
<figure class="bfl image">
<p class="image-img-wrap"><img alt="街路" src="image/snow-street-day.jpg" height="768" class="image-img" /></p>
</figure>
<figure class="bfl bfl-wfc bfl-wfc-wsd image">
<p class="image-img-wrap"><img alt="図5" src="image/snow-street-day.jpg" height="768" class="image-img" /></p>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">5</span></span> ⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄</figcaption>
</figure>

<figure class="bfl image image-page">
<p class="image-img-wrap"><img  alt="出発待ちの電車" src="image/train.jpg" height="768" title="🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃🚃" class="image-img" /></p>
</figure>

<figure class="bfl tandem image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図7a-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図7a-②" src="image/ramen-sumire.jpg" height="154" title="🍣2" class="image-img" /></p>
</figure>
</div>
</figure>

<figure class="bfl tandem tandem-wfc image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図8-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図8-②" src="image/ramen-sumire.jpg" height="154" srcset="image/ramen-sumire.jpg 3.125x" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">8</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>

<figure class="bfl tandem tandem-wfc tandem-wfc-wsd image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図9a-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図9a-②" src="image/ramen-sumire.jpg" height="154" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">9a</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>

<figure class="bfl tandem tandem-wfc tandem-wfc-wsd image">
<div class="tandem-wrap">
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図9b-①" src="image/snow-street-day.jpg" height="768" srcset="image/snow-street-day.jpg 3.125x" title="⛄1" class="image-img" /></p>
</figure>
<figure class="tandem-figure">
<p class="image-img-wrap"><img alt="図9b-②" src="image/snow-street-night.jpg" height="768" title="⛄2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">9b</span></span> ⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄⛄</figcaption>
</figure>

<figure class="bfl sidebyside image">
<div class="sidebyside-wrap">
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図10-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図10-②" src="image/ramen-sumire.jpg" height="154" title="🍣2" class="image-img" /></p>
</figure>
</div>
</figure>

<figure class="bfl sidebyside sidebyside-wfc image">
<div class="sidebyside-wrap">
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図11-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図11-②" src="image/ramen-sumire.jpg" height="154" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">11</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>

<figure class="bfl sidebyside sidebyside-wfc sidebyside-wfc-wsd image">
<div class="sidebyside-wrap">
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図12-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-figure">
<p class="image-img-wrap"><img alt="図12-②" src="image/ramen-sumire.jpg" height="154" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">12</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>

<figure class="bfl sidebyside-rtl image">
<div class="sidebyside-rtl-wrap">
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図13-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図13-②" src="image/ramen-sumire.jpg" height="154" title="🍣2" class="image-img" /></p>
</figure>
</div>
</figure>

<figure class="bfl sidebyside-rtl sidebysside-rtl-wfc image">
<div class="sidebyside-rtl-wrap">
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図14-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図14-②" src="image/ramen-sumire.jpg" height="154" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">14</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>

<figure class="bfl sidebyside-rtl sidebyside-rtl-wfc sidebyside-rtl-wsd image">
<div class="sidebyside-rtl-wrap">
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図15-①" src="image/ramen-nanashi.jpg" height="154" title="🍣1" class="image-img" /></p>
</figure>
<figure class="sidebyside-rtl-figure">
<p class="image-img-wrap"><img alt="図15-②" src="image/ramen-sumire.jpg" height="154" title="🍣2" class="image-img" /></p>
</figure>
</div>
<figcaption class="bfl-fc"><span class="bfl-fc-title">図<span class="bfl-fc-ordinal">15</span></span> 🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣🍣</figcaption>
</figure>
</divn>
</section>

<section class="svg-wrapping">
<h3 class="ch3">SVGラッピングを使った画像の配置</h3>
<p>前項の方法はiBooksのみを考えると上手く展開できます。しかしながら、Readiumを考慮すると良くありません。横長の画像の場合に、矩形比を保ったまま画面領域で上手く収まらないからです（iBooksでは読書システムが画像の矩形比をSVG画像のように保たせます）。</p>
<p>そこで、HTMLとCSSのみで解決するのを諦め、画像の配置には、いわゆるSVGラッピングと言われる手法を使うことにします。また、それにより、長さ指定でvw/vhの単位を使ってもiBooksが重くなることがありません（先の記述の何かが良くなかっただけかもしれませんが…）。よって、非常に按配が良いです。</p>
<p>ただし、KindleではSVGラッピングした画像を縮小できません。そこでフォールバックをかけます（svg要素内でフォールバックを記述したかったのですが、epubcheckを上手くパスできませんでした）。</p>
<p>結果、現時点で、Readium、iBooks、Kindleすべてに対応し、手元でのepub→mobi変換が簡易である図版配置の記述は、次のように書けます。</p>

<pre><code>&lt;figure class="image"&gt;
&lt;div class="image-svg-wrap"&gt;
&lt;svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="276.5px" height="230.4px" viewBox="0 0 276.5 230.4"&gt;
&lt;image xlink:href="image/sushi-tuna.jpg" xlink:title="鮨" width="864px" height="720px" transform="scale(0.32)" /&gt;
&lt;/svg&gt;
&lt;/div&gt;
&lt;img src="image/sushi-tuna.jpg" width="277" height="230" hidden="hidden" class="fallback-kf8" /&gt;
&lt;/figure&gt;</code></pre>

<p>なお、epubcheck時にwaringが表示されますが、それはバグです。</p>
<p>また、区経費を保つために画像の自動縮小が起こりえますが、それの違和感をなくすために、svg要素の背景には薄いグレーを敷くことをお勧めします。</p>

<figure class="image">
<div class="image-svg-wrap">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="276.5px" height="230.4px" viewBox="0 0 276.5 230.4">
<image xlink:href="image/sushi-tuna.jpg" xlink:title="鮨" width="864px" height="720px" transform="scale(0.32)" />
</svg>
</div>
<img src="image/sushi-tuna.jpg" width="277" height="230" hidden="hidden" class="fallback-kf8" />
</figure>

<p>※この項の図版は、CSSを書き加える前の状態です。</p>
</section>

</div>
</main>

<footer>
<p>、。<a href="https://github.com/peaceroad/css-layout">GitHub</a> / <a href="https://twitter.com/k_taka">@k_taka</a></p>
</footer>
</div>
  
</body>
</html>